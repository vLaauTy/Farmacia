<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turnos - SaludSync</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body class="theme-turnos">
    <nav class="navbar">
        <div class="navbar-left">
            <h1>ğŸ¥ SaludSync</h1>
        </div>
        <ul>
            <li><a href="javascript:history.back()" class="nav-back">â¬…ï¸ Volver</a></li>
            <li><a href="/">ğŸ¡ Inicio</a></li>
            <!-- Enlaces para administradores -->
            <li sec:authorize="hasRole('ADMIN')"><a href="/medicos">ğŸ‘¨â€âš•ï¸ MÃ©dicos</a></li>
            <li><a href="/pacientes">ğŸ§‘â€ğŸ¤â€ğŸ§‘ Pacientes</a></li>
            <li sec:authorize="hasRole('ADMIN')"><a href="/turnos">ğŸ“… Turnos</a></li>
            <!-- Enlaces adicionales para mÃ©dicos -->
            <li sec:authorize="hasRole('MEDICO')"><a href="/mis-turnos">ğŸ“… Mis Turnos</a></li>
            <li sec:authorize="hasRole('ADMIN')"><a href="/calendario">ğŸ“… Ver Calendario</a></li>
            <li><a href="/logout">ğŸšª Cerrar SesiÃ³n</a></li>
        </ul>
    </nav>

    <div class="container">

        <h2>ğŸ“… Lista de Turnos</h2>

        <!-- Mensaje de confirmaciÃ³n de cancelaciÃ³n -->
        <div th:if="${param.cancelado}" class="alert alert-success">
            âœ… <strong>Turno cancelado exitosamente.</strong> El turno ha sido agregado al contador de turnos cancelados
            del mes.
        </div>

        <!-- Header con estadÃ­sticas y acciones -->
        <div class="page-header">
            <div class="header-left">
                <h2>ğŸ“… GestiÃ³n de Turnos</h2>
            </div>
            <div class="header-actions" sec:authorize="hasRole('ADMIN')">
                <a href="/turnos/nuevo" class="btn btn-primary">â• Nuevo Turno</a>
                <a href="/calendario" class="btn btn-info">ğŸ“… Ver Calendario</a>
            </div>
        </div>

        <!-- EstadÃ­stica mensual debajo del header para no romper alineaciÃ³n del tÃ­tulo y acciones -->
        <div class="stats-info" sec:authorize="hasRole('ADMIN')">
            <div class="stat-card">
                <span class="stat-number" th:text="${turnosCanceladosDelMes}">0</span>
                <span class="stat-label">ğŸš« Cancelados en <span th:text="${nombreMes}">mes actual</span></span>
            </div>
        </div>

        <!-- Grid de turnos -->
        <div class="turnos-grid">
            <div th:each="turno : ${turnos}" class="turno-card">
                <div class="card-header">
                    <div class="fecha-hora">
                        <div class="fecha" th:text="${turno.dia + '/' + turno.mes + '/' + turno.anio}">15/10/2025</div>
                        <div class="hora" th:text="${turno.hora}">10:30</div>
                    </div>
                    <div class="turno-id" th:text="'#' + ${turno.id}">#123</div>
                </div>

                <div class="card-body">
                    <div class="participantes">
                        <div class="medico">
                            <span class="label">ğŸ‘¨â€âš•ï¸ MÃ©dico:</span>
                            <span class="name" th:text="${turno.medico?.nombre + ' ' + turno.medico?.apellido}">Dr. Juan
                                PÃ©rez</span>
                        </div>
                        <div class="paciente">
                            <span class="label">ğŸ‘¤ Paciente:</span>
                            <span class="name"
                                th:text="${turno.paciente?.nombre + ' ' + turno.paciente?.apellido}">MarÃ­a GarcÃ­a</span>
                        </div>
                    </div>
                </div>

                <div class="card-actions" sec:authorize="hasRole('ADMIN')">
                    <a th:href="@{'/turnos/editar/' + ${turno.id}}" class="btn btn-edit">âœï¸ Editar</a>
                    <a href="#" class="btn btn-delete"
                        th:onclick="'mostrarConfirmacionEliminacion(' + ${turno.id} + ')'">ğŸ—‘ï¸ Eliminar</a>
                </div>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(turnos)}" class="empty-message">
            <p>ğŸ“… No hay turnos registrados</p>
            <a href="/turnos/nuevo" class="btn btn-primary" sec:authorize="hasRole('ADMIN')">Crear primer turno</a>
        </div>
    </div>
    </div>

    <!-- Modal de confirmaciÃ³n de eliminaciÃ³n -->
    <div id="modalConfirmacion" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš ï¸ Confirmar EliminaciÃ³n</h3>
            </div>
            <div class="modal-body">
                <p><strong>Â¿EstÃ¡s seguro de eliminar este turno?</strong></p>
                <p class="warning-text">Si lo eliminas, el turno serÃ¡ contabilizado en el contador de <strong>turnos
                        cancelados del mes</strong>.</p>
                <p class="note-text">Esta acciÃ³n no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal()">âŒ Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">ğŸ—‘ï¸ Eliminar
                    Turno</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaciÃ³n para eliminar turno -->
    <div id="modalConfirmacion" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš ï¸ Confirmar CancelaciÃ³n de Turno</h3>
            </div>
            <div class="modal-body">
                <p class="warning-text">Â¿EstÃ¡ seguro que desea cancelar este turno?</p>
                <p>Esta acciÃ³n no se puede deshacer.</p>
                <p class="note-text">El turno serÃ¡ marcado como cancelado en el sistema.</p>
            </div>
            <div class="modal-footer">
                <button onclick="confirmarEliminacion()" class="btn btn-danger">SÃ­, Cancelar Turno</button>
                <button onclick="cerrarModal()" class="btn btn-secondary">No, Mantener Turno</button>
            </div>
        </div>
    </div>

    <script>
        let turnoIdAEliminar = null;

        function mostrarConfirmacionEliminacion(turnoId) {
            turnoIdAEliminar = turnoId;
            document.getElementById('modalConfirmacion').style.display = 'flex';

            // Prevenir scroll del body
            document.body.style.overflow = 'hidden';
        }

        function cerrarModal() {
            document.getElementById('modalConfirmacion').style.display = 'none';
            turnoIdAEliminar = null;

            // Restaurar scroll del body
            document.body.style.overflow = 'auto';
        }

        function confirmarEliminacion() {
            if (turnoIdAEliminar) {
                // Redirigir al endpoint de eliminaciÃ³n
                window.location.href = `/turnos/eliminar/${turnoIdAEliminar}`;
            }
        }

        // Cerrar modal al hacer clic fuera de Ã©l
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('modalConfirmacion');
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    cerrarModal();
                }
            });

        });
    </script>
</body>

</html>