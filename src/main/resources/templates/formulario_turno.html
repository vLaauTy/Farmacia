<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turno - Sistema Farmacia</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-logo">Sistema Farmacia - TURNO</div>
            <div class="navbar-links">
                <a href="/turnos" class="btn-back">‚Üê Volver</a>
                <a href="/logout">Cerrar Sesi√≥n</a>
            </div>
        </nav>

        <h2 th:text="${turno.id != null} ? '‚úèÔ∏è Editar Turno' : 'üìÖ Nuevo Turno'"></h2>

        <div th:if="${error}" class="error-message">
            <p th:text="${error}"></p>
        </div>

        <!-- Formulario √∫nico -->
        <form th:action="${turno.id != null} ? @{'/turnos/editar/' + ${turno.id}} : @{/turnos/guardar}"
            th:object="${turno}" method="post">

            <fieldset>
                <legend>üìÖ Informaci√≥n del Turno</legend>

                <label for="medico">üë®‚Äç‚öïÔ∏è M√©dico:</label>
                <select name="medico" id="medico" required onchange="cargarHorarios()">
                    <option value="">Seleccione un m√©dico</option>
                    <option th:each="medico : ${medicos}" th:value="${medico.id}"
                        th:text="${medico.nombre + ' ' + medico.apellido + ' - ' + medico.especialidad + ' - ' + medico.horario}"
                        th:selected="${turno.medico != null and turno.medico.id == medico.id}"
                        th:data-horario="${medico.horario}">
                    </option>
                </select>

                <label for="paciente">üë§ Paciente:</label>
                <select name="paciente" id="paciente" required>
                    <option value="">Seleccione un paciente</option>
                    <option th:each="paciente : ${pacientes}" th:value="${paciente.id}"
                        th:text="${paciente.nombre + ' ' + paciente.apellido + ' - DNI: ' + paciente.dni}"
                        th:selected="${turno.paciente != null and turno.paciente.id == paciente.id}">
                    </option>
                </select>

                <label for="dia">üìÖ D√≠a:</label>
                <input type="number" th:field="*{dia}" id="dia" placeholder="D√≠a" min="1" max="31" required onchange="cargarHorarios()">

                <label for="mes">üìÖ Mes:</label>
                <select th:field="*{mes}" id="mes" required onchange="cargarHorarios()">
                    <option value="">Seleccione mes</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>

                <label for="anio">üìÖ A√±o:</label>
                <input type="number" th:field="*{anio}" id="anio" placeholder="2025" min="2024" max="2030"
                    th:value="${turno.anio != null} ? ${turno.anio} : 2025" required onchange="cargarHorarios()">

                <label for="hora">üïí Hora disponible:</label>
                <select name="hora" id="hora" required>
                    <option value="">Primero seleccione un m√©dico</option>
                    <option th:each="hora : ${horariosDisponibles}" th:value="${hora}" th:text="${hora}"
                        th:selected="${turno.hora != null and turno.hora == hora}">
                    </option>
                </select>

            </fieldset>

            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" class="btn btn-primary"
                    th:text="${turno.id != null} ? 'üíæ Guardar Cambios' : 'üíæ Crear Turno'"></button>
                <a href="/turnos" class="btn btn-secondary">‚ùå Cancelar</a>
            </div>
        </form>
    </div>

    <script>
        // Funci√≥n para cargar horarios disponibles seg√∫n el m√©dico y fecha seleccionados
        function cargarHorarios() {
            const medicoId = document.getElementById('medico').value;
            const dia = document.getElementById('dia').value;
            const mes = document.getElementById('mes').value;
            const anio = document.getElementById('anio').value;
            const selectHora = document.getElementById('hora');

            // Limpiar opciones actuales
            selectHora.innerHTML = '<option value="">Cargando horarios...</option>';

            if (!medicoId) {
                selectHora.innerHTML = '<option value="">Primero seleccione un m√©dico</option>';
                return;
            }

            // Construir URL con par√°metros de fecha
            let url = `/turnos/horarios/${medicoId}`;
            const params = new URLSearchParams();
            
            if (dia && mes && anio) {
                params.append('dia', dia);
                params.append('mes', mes);
                params.append('anio', anio);
            }

            // Agregar ID del turno si estamos editando
            const turnoId = new URLSearchParams(window.location.search).get('id') || 
                           window.location.pathname.match(/\/turnos\/editar\/(\d+)/)?.[1];
            if (turnoId) {
                params.append('turnoId', turnoId);
            }

            if (params.toString()) {
                url += '?' + params.toString();
            }

            // Hacer petici√≥n AJAX para obtener horarios disponibles
            fetch(url)
                .then(response => response.json())
                .then(horarios => {
                    selectHora.innerHTML = '<option value="">Seleccione una hora</option>';
                    
                    if (horarios.length === 0) {
                        selectHora.innerHTML = '<option value="">No hay horarios disponibles para esta fecha</option>';
                        return;
                    }
                    
                    horarios.forEach(hora => {
                        const option = document.createElement('option');
                        option.value = hora;
                        option.textContent = hora;
                        selectHora.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar horarios:', error);
                    selectHora.innerHTML = '<option value="">Error al cargar horarios</option>';
                });
        }

        // Cargar horarios al cargar la p√°gina si hay un m√©dico seleccionado
        document.addEventListener('DOMContentLoaded', function () {
            const medicoSelect = document.getElementById('medico');
            const horaSelect = document.getElementById('hora');
            const anioInput = document.getElementById('anio');

            // Establecer a√±o por defecto a 2025 si est√° vac√≠o (nuevo turno)
            if (!anioInput.value || anioInput.value === '') {
                anioInput.value = 2025;
            }

            // Guardar la hora actual si estamos editando un turno
            const horaActual = horaSelect.querySelector('option[selected]')?.value;

            if (medicoSelect.value) {
                // Cargar horarios disponibles
                cargarHorarios();
                
                // Si hay una hora preseleccionada (edici√≥n), seleccionarla despu√©s de cargar
                if (horaActual) {
                    setTimeout(() => {
                        const option = horaSelect.querySelector(`option[value="${horaActual}"]`);
                        if (option) {
                            option.selected = true;
                        }
                    }, 500);
                }
            }
        });
    </script>

    <style>
        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            color: #721c24;
        }

        .btn-back {
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s ease;
            margin-right: 15px;
        }

        .btn-back:hover {
            background-color: #5a6268;
            color: white;
            text-decoration: none;
        }

        #hora:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .loading-message {
            color: #007bff;
            font-style: italic;
        }
    </style>


</body>

</html>