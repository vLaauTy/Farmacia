<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turno - Sistema Farmacia</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-logo">Sistema Farmacia - TURNO</div>
            <div class="navbar-links">
                <a href="/turnos" class="btn-back">‚Üê Volver</a>
                <a href="/logout">Cerrar Sesi√≥n</a>
            </div>
        </nav>

        <h2 th:text="${turno.id != null} ? '‚úèÔ∏è Editar Turno' : 'üìÖ Nuevo Turno'"></h2>

        <div th:if="${error}" class="error-message">
            <p th:text="${error}"></p>
        </div>

        <form th:action="${turno.id != null} ? @{'/turnos/editar/' + ${turno.id}} : @{/turnos/formulario}" method="get"
            id="filtroForm" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">

            <input type="hidden" name="turnoId" th:value="${turno.id}" th:if="${turno.id != null}">

            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                <div>
                    <label for="filtro-medico">üë®‚Äç‚öïÔ∏è M√©dico:</label>
                    <select name="medicoId" id="filtro-medico" onchange="this.form.submit()">
                        <option value="">Seleccione un m√©dico</option>
                        <option th:each="medico : ${medicos}" th:value="${medico.id}"
                            th:text="${medico.nombre + ' ' + medico.apellido + ' - ' + medico.especialidad}"
                            th:selected="${medicoSeleccionado != null and medicoSeleccionado == medico.id}">
                        </option>
                    </select>
                </div>

                <div>
                    <label for="filtro-dia">üìÖ D√≠a:</label>
                    <input type="number" name="dia" id="filtro-dia" placeholder="D√≠a" min="1" max="31"
                        th:value="${diaSeleccionado}" onchange="this.form.submit()">
                </div>

                <div>
                    <label for="filtro-mes">üìÖ Mes:</label>
                    <select name="mes" id="filtro-mes" onchange="this.form.submit()">
                        <option value="">Mes</option>
                        <option value="1" th:selected="${mesSeleccionado == 1}">Enero</option>
                        <option value="2" th:selected="${mesSeleccionado == 2}">Febrero</option>
                        <option value="3" th:selected="${mesSeleccionado == 3}">Marzo</option>
                        <option value="4" th:selected="${mesSeleccionado == 4}">Abril</option>
                        <option value="5" th:selected="${mesSeleccionado == 5}">Mayo</option>
                        <option value="6" th:selected="${mesSeleccionado == 6}">Junio</option>
                        <option value="7" th:selected="${mesSeleccionado == 7}">Julio</option>
                        <option value="8" th:selected="${mesSeleccionado == 8}">Agosto</option>
                        <option value="9" th:selected="${mesSeleccionado == 9}">Septiembre</option>
                        <option value="10" th:selected="${mesSeleccionado == 10}">Octubre</option>
                        <option value="11" th:selected="${mesSeleccionado == 11}">Noviembre</option>
                        <option value="12" th:selected="${mesSeleccionado == 12}">Diciembre</option>
                    </select>
                </div>

                <div>
                    <label for="filtro-anio">üìÖ A√±o:</label>
                    <input type="number" name="anio" id="filtro-anio" placeholder="2025" min="2024" max="2030"
                        th:value="${anioSeleccionado != null ? anioSeleccionado : 2025}" onchange="this.form.submit()">
                </div>

                <div>
                    <button type="submit" class="btn btn-secondary" style="width: 100%;">üîç Filtrar Horarios</button>
                </div>
            </div>
        </form>

        <!-- Formulario principal para guardar el turno -->
        <form th:action="${turno.id != null} ? @{'/turnos/editar/' + ${turno.id}} : @{/turnos/guardar}"
            th:object="${turno}" method="post">

            <fieldset>
                <legend>üìÖ Informaci√≥n del Turno</legend>

                <label for="medico">üë®‚Äç‚öïÔ∏è M√©dico:</label>
                <select name="medico" id="medico" required>
                    <option value="">Seleccione un m√©dico</option>
                    <option th:each="medico : ${medicos}" th:value="${medico.id}"
                        th:text="${medico.nombre + ' ' + medico.apellido + ' - ' + medico.especialidad + ' - ' + medico.horario}"
                        th:selected="${(turno.medico != null and turno.medico.id == medico.id) or (medicoSeleccionado != null and medicoSeleccionado == medico.id)}">
                    </option>
                </select>

                <label for="paciente">üë§ Paciente:</label>
                <select name="paciente" id="paciente" required>
                    <option value="">Seleccione un paciente</option>
                    <option th:each="paciente : ${pacientes}" th:value="${paciente.id}"
                        th:text="${paciente.nombre + ' ' + paciente.apellido + ' - DNI: ' + paciente.dni}"
                        th:selected="${turno.paciente != null and turno.paciente.id == paciente.id}">
                    </option>
                </select>

                <label for="dia">üìÖ D√≠a:</label>
                <input type="number" th:field="*{dia}" id="dia" placeholder="D√≠a" min="1" max="31" required
                    th:value="${diaSeleccionado != null ? diaSeleccionado : turno.dia}">

                <label for="mes">üìÖ Mes:</label>
                <select th:field="*{mes}" id="mes" required>
                    <option value="">Seleccione mes</option>
                    <option value="1"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 1) or (turno.mes != null and turno.mes == 1)}">
                        Enero</option>
                    <option value="2"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 2) or (turno.mes != null and turno.mes == 2)}">
                        Febrero</option>
                    <option value="3"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 3) or (turno.mes != null and turno.mes == 3)}">
                        Marzo</option>
                    <option value="4"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 4) or (turno.mes != null and turno.mes == 4)}">
                        Abril</option>
                    <option value="5"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 5) or (turno.mes != null and turno.mes == 5)}">
                        Mayo</option>
                    <option value="6"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 6) or (turno.mes != null and turno.mes == 6)}">
                        Junio</option>
                    <option value="7"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 7) or (turno.mes != null and turno.mes == 7)}">
                        Julio</option>
                    <option value="8"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 8) or (turno.mes != null and turno.mes == 8)}">
                        Agosto</option>
                    <option value="9"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 9) or (turno.mes != null and turno.mes == 9)}">
                        Septiembre</option>
                    <option value="10"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 10) or (turno.mes != null and turno.mes == 10)}">
                        Octubre</option>
                    <option value="11"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 11) or (turno.mes != null and turno.mes == 11)}">
                        Noviembre</option>
                    <option value="12"
                        th:selected="${(mesSeleccionado != null and mesSeleccionado == 12) or (turno.mes != null and turno.mes == 12)}">
                        Diciembre</option>
                </select>

                <label for="anio">üìÖ A√±o:</label>
                <input type="number" th:field="*{anio}" id="anio" placeholder="2025" min="2024" max="2030" required
                    th:value="${anioSeleccionado != null ? anioSeleccionado : (turno.anio != null ? turno.anio : 2025)}">

                <!-- Mostrar horarios disponibles solo si se han cargado -->
                <div th:if="${horariosDisponibles != null and !horariosDisponibles.empty}">
                    <label for="hora">üïí Hora disponible:</label>
                    <select name="hora" id="hora" required>
                        <option value="">Seleccione una hora</option>
                        <option th:each="hora : ${horariosDisponibles}" th:value="${hora}" th:text="${hora}"
                            th:selected="${turno.hora != null and turno.hora == hora}">
                        </option>
                    </select>
                </div>

                <!-- Mensaje si no hay horarios disponibles -->
                <div th:if="${horariosDisponibles != null and horariosDisponibles.empty}" class="no-horarios-message">
                    <label>üïí Horarios:</label>
                    <p style="color: #dc3545; font-style: italic;">No hay horarios disponibles para la fecha
                        seleccionada.</p>
                </div>

                <!-- Mensaje si no se han seleccionado m√©dico y fecha -->
                <div th:if="${horariosDisponibles == null}" class="sin-filtros-message">
                    <label>üïí Horarios:</label>
                    <p style="color: #6c757d; font-style: italic;">Use el filtro superior para seleccionar un m√©dico y
                        fecha, y ver los horarios disponibles.</p>
                </div>

            </fieldset>

            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" class="btn btn-primary"
                    th:text="${turno.id != null} ? 'üíæ Guardar Cambios' : 'üíæ Crear Turno'"
                    th:disabled="${horariosDisponibles == null or horariosDisponibles.empty}">
                </button>
                <a href="/turnos" class="btn btn-secondary">‚ùå Cancelar</a>
            </div>
        </form>
    </div>

    <style>
        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            color: #721c24;
        }

        .btn-back {
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s ease;
            margin-right: 15px;
        }

        .btn-back:hover {
            background-color: #5a6268;
            color: white;
            text-decoration: none;
        }

        .no-horarios-message,
        .sin-filtros-message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
        }

        .no-horarios-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .sin-filtros-message {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #6c757d !important;
        }

        #filtroForm {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        fieldset {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        legend {
            font-weight: bold;
            color: #495057;
            padding: 0 10px;
        }

        /* Indicador visual de que el formulario requiere filtros */
        .filter-required {
            border-left: 4px solid #ffc107;
            padding-left: 10px;
        }
    </style>


</body>

</html>