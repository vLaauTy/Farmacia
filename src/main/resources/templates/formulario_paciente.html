<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Paciente - SaludSync</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body class="theme-pacientes">
    <div class="container">
        <nav class="navbar">
            <div class="navbar-left">
                <h1>üè• SaludSync</h1>
            </div>
            <ul>
                <li><a href="javascript:history.back()" class="nav-back">‚¨ÖÔ∏è Volver</a></li>
            </ul>
        </nav>
        <h2
            th:text="${esMedico} ? 'ü©∫ Consulta de Paciente' : (${paciente.id != null} ? '‚úèÔ∏è Editar Paciente' : 'ü©∫ Registrar Nuevo Paciente')">
        </h2>

        <!-- Mensaje informativo para m√©dicos -->
        <div th:if="${esMedico}" class="medico-info">
            ‚ÑπÔ∏è <strong>Modo M√©dico:</strong> Los datos personales est√°n protegidos. Solo puede modificar el historial
            cl√≠nico.
        </div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="error-message">
            <strong>‚ö†Ô∏è Error:</strong> <span th:text="${error}"></span>
        </div>

        <!-- Mensaje de √©xito -->
        <div th:if="${param.exito}" class="success-message">
            <strong>‚úÖ √âxito:</strong>
            <span th:if="${param.exito[0] == 'paciente_guardado'}">Paciente registrado correctamente.</span>
            <span th:if="${param.exito[0] == 'paciente_actualizado'}">Paciente actualizado correctamente.</span>
        </div>

        <form th:action="${paciente.id != null} ? @{'/pacientes/editar/' + ${paciente.id}} : @{/pacientes/guardar}"
            th:object="${paciente}" method="post">
            <fieldset>
                <legend>ü©∫ Informaci√≥n del Paciente</legend>

                <div>
                    <label for="nombre">Nombre:</label>
                    <input type="text" th:field="*{nombre}" id="nombre" placeholder="Ingrese nombre"
                        th:readonly="${esMedico}" required>

                    <label for="apellido">Apellido:</label>
                    <input type="text" th:field="*{apellido}" id="apellido" placeholder="Ingrese apellido"
                        th:readonly="${esMedico}" required>

                    <label for="dni">DNI:</label>
                    <input type="text" th:field="*{dni}" id="dni" placeholder="12345678" pattern="[0-9]{7,8}"
                        title="DNI de 7 u 8 d√≠gitos" th:readonly="${esMedico}"
                        th:class="${error != null ? 'campo-error' : ''}" required>

                    <label for="domicilio">Domicilio:</label>
                    <input type="text" th:field="*{domicilio}" id="domicilio" placeholder="Calle, n√∫mero, ciudad"
                        th:readonly="${esMedico}" required>

                    <label for="telefono">Tel√©fono:</label>
                    <input type="tel" th:field="*{telefono}" id="telefono" placeholder="11-1234-5678"
                        pattern="[0-9\-\+\(\)\s]+" title="Formato: 11-1234-5678" th:readonly="${esMedico}" required>

                    <label for="obraSocial">¬øTiene Obra Social?</label>
                    <select th:field="*{obraSocial}" id="obraSocial" th:disabled="${esMedico}" required>
                        <option value="">Seleccione</option>
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                    </select>

                    <!-- Campos de obra social que se mostrar√°n/ocultar√°n -->
                    <div id="camposObraSocial">
                        <label for="nombreObraSocial">Obra Social:</label>
                        <select th:field="*{nombreObraSocial}" id="nombreObraSocial" th:disabled="${esMedico}">
                            <option value="">Seleccione una obra social</option>
                            <option value="OSDE">OSDE</option>
                            <option value="Swiss Medical">Swiss Medical</option>
                            <option value="Galeno">Galeno</option>
                            <option value="Medicus">Medicus</option>
                            <option value="Accord Salud">Accord Salud</option>
                            <option value="Omint">Omint</option>
                            <option value="Hospital Italiano">Hospital Italiano</option>
                            <option value="Hospital Alem√°n">Hospital Alem√°n</option>
                            <option value="Sancor Salud">Sancor Salud</option>
                            <option value="Federada Salud">Federada Salud</option>
                            <option value="IOMA">IOMA</option>
                            <option value="PAMI">PAMI</option>
                            <option value="Obra Social del Personal de la Alimentaci√≥n">Obra Social del Personal de la
                                Alimentaci√≥n</option>
                            <option value="OSECAC">OSECAC</option>
                            <option value="OSDEPYM">OSDEPYM</option>
                            <option value="Otra">Otra</option>
                        </select>

                        <label for="plan">Plan:</label>
                        <input type="text" th:field="*{plan}" id="plan" placeholder="Ej: Plan 210, Plan Familiar, etc."
                            th:readonly="${esMedico}">

                        <label for="afiliado">N¬∞ de Afiliado:</label>
                        <input type="text" th:field="*{afiliado}" id="afiliado" placeholder="N√∫mero de afiliado"
                            th:readonly="${esMedico}">
                    </div>
                </div>

                <!-- Historial cl√≠nico solo para m√©dicos -->
                <div th:if="${esMedico}">
                    <fieldset class="historial-fieldset">
                        <legend class="historial-legend">ü©∫ Historial Cl√≠nico</legend>
                        <label for="historialClinico">Historial Cl√≠nico:</label>
                        <textarea th:field="*{historialClinico}" id="historialClinico" rows="6"
                            placeholder="Observaciones m√©dicas, antecedentes, diagn√≥sticos, tratamientos, etc."></textarea>
                    </fieldset>
                </div>
            </fieldset>

            <div class="form-buttons">
                <button type="submit" class="btn btn-primary"
                    th:text="${esMedico} ? 'üíæ Actualizar Historial Cl√≠nico' : (${paciente.id != null} ? 'üíæ Guardar Cambios' : 'üíæ Registrar Paciente')"></button>
                <a href="/pacientes" class="btn btn-secondary">‚ùå Cancelar</a>
            </div>
        </form>
    </div>

    <script>
        // Validaci√≥n de DNI en tiempo real
        document.getElementById('dni').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
        });

        // Control de visibilidad de campos de obra social
        function toggleCamposObraSocial() {
            const tieneObraSocial = document.getElementById('obraSocial').value;
            const camposObraSocial = document.getElementById('camposObraSocial');
            const selectObraSocial = document.getElementById('nombreObraSocial');
            const inputPlan = document.getElementById('plan');
            const inputAfiliado = document.getElementById('afiliado');

            if (tieneObraSocial === 'true') {
                camposObraSocial.style.display = 'block';
                camposObraSocial.classList.add('show');
                // Hacer campos obligatorios
                selectObraSocial.setAttribute('required', 'required');
                inputPlan.setAttribute('required', 'required');
                inputAfiliado.setAttribute('required', 'required');
            } else {
                camposObraSocial.style.display = 'none';
                camposObraSocial.classList.remove('show');
                // Limpiar valores y quitar requerimiento
                selectObraSocial.value = '';
                inputPlan.value = '';
                inputAfiliado.value = '';
                selectObraSocial.removeAttribute('required');
                inputPlan.removeAttribute('required');
                inputAfiliado.removeAttribute('required');
            }
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function () {
            toggleCamposObraSocial();
            document.getElementById('obraSocial').addEventListener('change', toggleCamposObraSocial);
        });
    </script>

</body>

</html>