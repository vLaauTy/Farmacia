<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Paciente - SaludSync</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>

<body>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-left">
                <h1>üè• SaludSync</h1>
            </div>
            <ul>
                <li><a href="javascript:history.back()" class="nav-back">‚¨ÖÔ∏è Volver</a></li>
            </ul>
        </nav>
        <h2
            th:text="${esMedico} ? 'ü©∫ Consulta de Paciente' : (${paciente.id != null} ? '‚úèÔ∏è Editar Paciente' : 'ü©∫ Registrar Nuevo Paciente')">
        </h2>

        <!-- Mensaje informativo para m√©dicos -->
        <div th:if="${esMedico}" class="medico-info">
            ‚ÑπÔ∏è <strong>Modo M√©dico:</strong> Los datos personales est√°n protegidos. Solo puede modificar el historial
            cl√≠nico.
        </div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="error-message">
            <strong>‚ö†Ô∏è Error:</strong> <span th:text="${error}"></span>
        </div>

        <!-- Mensaje de √©xito -->
        <div th:if="${param.exito}" class="success-message">
            <strong>‚úÖ √âxito:</strong>
            <span th:if="${param.exito[0] == 'paciente_guardado'}">Paciente registrado correctamente.</span>
            <span th:if="${param.exito[0] == 'paciente_actualizado'}">Paciente actualizado correctamente.</span>
        </div>

        <form th:action="${paciente.id != null} ? @{'/pacientes/editar/' + ${paciente.id}} : @{/pacientes/guardar}"
            th:object="${paciente}" method="post">
            <fieldset>
                <legend>ü©∫ Informaci√≥n del Paciente</legend>

                <div>
                    <label for="nombre">Nombre:</label>
                    <input type="text" th:field="*{nombre}" id="nombre" placeholder="Ingrese nombre"
                        th:readonly="${esMedico}" required>

                    <label for="apellido">Apellido:</label>
                    <input type="text" th:field="*{apellido}" id="apellido" placeholder="Ingrese apellido"
                        th:readonly="${esMedico}" required>

                    <label for="dni">DNI:</label>
                    <input type="text" th:field="*{dni}" id="dni" placeholder="12345678" pattern="[0-9]{7,8}"
                        title="DNI de 7 u 8 d√≠gitos" th:readonly="${esMedico}"
                        th:class="${error != null ? 'campo-error' : ''}" required>

                    <label for="domicilio">Domicilio:</label>
                    <input type="text" th:field="*{domicilio}" id="domicilio" placeholder="Calle, n√∫mero, ciudad"
                        th:readonly="${esMedico}" required>

                    <label for="telefono">Tel√©fono:</label>
                    <input type="tel" th:field="*{telefono}" id="telefono" placeholder="11-1234-5678"
                        pattern="[0-9\-\+\(\)\s]+" title="Formato: 11-1234-5678" th:readonly="${esMedico}" required>

                    <label for="obraSocial">¬øTiene Obra Social?</label>
                    <select th:field="*{obraSocial}" id="obraSocial" th:disabled="${esMedico}" required>
                        <option value="">Seleccione</option>
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                    </select>

                    <!-- Campos de obra social que se mostrar√°n/ocultar√°n -->
                    <div id="camposObraSocial">
                        <label for="nombreObraSocial">Obra Social:</label>
                        <select th:field="*{nombreObraSocial}" id="nombreObraSocial" th:disabled="${esMedico}">
                            <option value="">Seleccione una obra social</option>
                            <option value="OSDE">OSDE</option>
                            <option value="Swiss Medical">Swiss Medical</option>
                            <option value="Galeno">Galeno</option>
                            <option value="Medicus">Medicus</option>
                            <option value="Accord Salud">Accord Salud</option>
                            <option value="Omint">Omint</option>
                            <option value="Hospital Italiano">Hospital Italiano</option>
                            <option value="Hospital Alem√°n">Hospital Alem√°n</option>
                            <option value="Sancor Salud">Sancor Salud</option>
                            <option value="Federada Salud">Federada Salud</option>
                            <option value="IOMA">IOMA</option>
                            <option value="PAMI">PAMI</option>
                            <option value="Obra Social del Personal de la Alimentaci√≥n">Obra Social del Personal de la Alimentaci√≥n</option>
                            <option value="OSECAC">OSECAC</option>
                            <option value="OSDEPYM">OSDEPYM</option>
                            <option value="Otra">Otra</option>
                        </select>

                        <label for="plan">Plan:</label>
                        <input type="text" th:field="*{plan}" id="plan" placeholder="Ej: Plan 210, Plan Familiar, etc."
                            th:readonly="${esMedico}">

                        <label for="afiliado">N¬∞ de Afiliado:</label>
                        <input type="text" th:field="*{afiliado}" id="afiliado" placeholder="N√∫mero de afiliado"
                            th:readonly="${esMedico}">
                    </div>
                </div>

                <!-- Historial cl√≠nico solo para m√©dicos -->
                <div th:if="${esMedico}">
                    <fieldset class="historial-fieldset">
                        <legend class="historial-legend">ü©∫ Historial Cl√≠nico</legend>
                        <label for="historialClinico">Historial Cl√≠nico:</label>
                        <textarea th:field="*{historialClinico}" id="historialClinico" rows="6"
                            placeholder="Observaciones m√©dicas, antecedentes, diagn√≥sticos, tratamientos, etc."></textarea>
                    </fieldset>
                </div>
            </fieldset>

            <div class="form-buttons">
                <button type="submit" class="btn btn-primary"
                    th:text="${esMedico} ? 'üíæ Actualizar Historial Cl√≠nico' : (${paciente.id != null} ? 'üíæ Guardar Cambios' : 'üíæ Registrar Paciente')"></button>
                <a href="/pacientes" class="btn btn-secondary">‚ùå Cancelar</a>
            </div>
        </form>
    </div>

    <script>
        // Validaci√≥n de DNI en tiempo real
        document.getElementById('dni').addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
        });

        // Control de visibilidad de campos de obra social
        function toggleCamposObraSocial() {
            const tieneObraSocial = document.getElementById('obraSocial').value;
            const camposObraSocial = document.getElementById('camposObraSocial');
            const selectObraSocial = document.getElementById('nombreObraSocial');
            const inputPlan = document.getElementById('plan');
            const inputAfiliado = document.getElementById('afiliado');

            if (tieneObraSocial === 'true') {
                camposObraSocial.style.display = 'block';
                camposObraSocial.classList.add('show');
                // Hacer campos obligatorios
                selectObraSocial.setAttribute('required', 'required');
                inputPlan.setAttribute('required', 'required');
                inputAfiliado.setAttribute('required', 'required');
            } else {
                camposObraSocial.style.display = 'none';
                camposObraSocial.classList.remove('show');
                // Limpiar valores y quitar requerimiento
                selectObraSocial.value = '';
                inputPlan.value = '';
                inputAfiliado.value = '';
                selectObraSocial.removeAttribute('required');
                inputPlan.removeAttribute('required');
                inputAfiliado.removeAttribute('required');
            }
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            toggleCamposObraSocial();
            document.getElementById('obraSocial').addEventListener('change', toggleCamposObraSocial);
        });
    </script>

    <style>
        /* Estilos para campos de solo lectura cuando es m√©dico */
        input[readonly],
        select[disabled] {
            background-color: #f8f9fa !important;
            border: 2px solid #e9ecef !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
        }

        /* Mensaje informativo para m√©dicos */
        .medico-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            color: #1565c0;
            font-weight: bold;
        }

        /* Mensajes de error y √©xito */
        .error-message, .success-message {
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-in-out;
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Historial cl√≠nico */
        .historial-fieldset {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .historial-legend {
            color: #007bff;
            font-weight: bold;
        }

        #historialClinico {
            width: 100%;
            min-height: 120px;
            border: 2px solid #28a745 !important;
            background-color: #f8fff9 !important;
        }

        /* Destacar campo con error */
        .campo-error {
            border: 2px solid #dc3545 !important;
            background-color: #fff5f5 !important;
        }

        /* Campos de obra social */
        #camposObraSocial {
            transition: all 0.3s ease-in-out;
            background-color: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }

        #camposObraSocial label {
            color: #495057;
            font-weight: 500;
        }

        #nombreObraSocial {
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
        }

        #nombreObraSocial:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
            outline: 0;
        }

        /* Destacar campos requeridos de obra social */
        #camposObraSocial input[required],
        #camposObraSocial select[required] {
            border-left: 3px solid #28a745;
        }

        /* Animaci√≥n para mostrar campos */
        #camposObraSocial.show {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 15px;
            }
            to {
                opacity: 1;
                max-height: 200px;
                padding: 15px;
            }
        }

        /* Botones del formulario */
        .form-buttons {
            text-align: center;
            margin-top: 30px;
        }

        /* Estilo para bot√≥n Volver */
        .btn-back {
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s ease;
            margin-right: 15px;
        }

        .btn-back:hover {
            background-color: #5a6268;
            color: white;
            text-decoration: none;
        }
    </style>
</body>

</html>